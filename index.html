
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced MP4 Video Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles untuk input range (progress & volume bars) */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            background-color: rgba(100, 116, 139, 0.5); /* slate-500/50 */
            height: 0.375rem; /* h-1.5 */
            border-radius: 9999px;
        }
        input[type="range"]::-moz-range-track {
            background-color: rgba(100, 116, 139, 0.5);
            height: 0.375rem;
            border-radius: 9999px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            margin-top: -4px; /* Vertically center */
            height: 1rem;
            width: 1rem;
            background-color: white;
            border-radius: 9999px;
            transform: scale(0);
            transition: transform 0.2s ease-in-out;
        }
        input[type="range"]:hover::-webkit-slider-thumb {
            transform: scale(1);
        }
        input[type="range"]::-moz-range-thumb {
            height: 1rem;
            width: 1rem;
            background-color: white;
            border-radius: 9999px;
            border: none;
            transform: scale(0);
            transition: transform 0.2s ease-in-out;
        }
        input[type="range"]:hover::-moz-range-thumb {
            transform: scale(1);
        }
        .progress-bar {
            accent-color: #06b6d4; /* cyan-500 */
        }
        .volume-bar {
            accent-color: white;
        }
    </style>
</head>

<body class="bg-slate-900 h-full">

    <div id="app-container" class="min-h-screen bg-slate-900 text-white flex flex-col items-center p-4 sm:p-8">
        <div class="w-full max-w-4xl">
            <header class="mb-8 text-center">
                <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">Video Player & Embed Generator</h1>
                <p class="text-slate-400 mt-2">Enter a video link, add sources, then generate an embeddable player.</p>
            </header>

            <div class="bg-slate-800 rounded-lg p-4 sm:p-6 mb-8 shadow-lg space-y-4">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input id="video-url-input" type="url" value="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" placeholder="Enter primary MP4 video URL" class="flex-grow bg-slate-700 text-white placeholder-slate-400 rounded-md px-4 py-2 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" />
                    <button id="load-video-btn" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-6 rounded-md transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-75">
                        Load Video
                    </button>
                </div>
                <details class="bg-slate-700/50 rounded-md">
                    <summary class="cursor-pointer font-semibold text-slate-300 p-4">Add More Resolutions & Subtitles</summary>
                    <form id="add-resource-form" class="p-4 border-t border-slate-600 grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <select name="type" id="resource-type-select" class="bg-slate-700 rounded-md px-3 py-2 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 sm:col-span-2">
                            <option value="resolution">Resolution</option>
                            <option value="subtitle">Subtitle</option>
                        </select>
                        <input name="label" placeholder="Label (e.g., 480p or English)" required class="bg-slate-700 rounded-md px-3 py-2 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-cyan-500" />
                        <input name="lang" placeholder="Lang Code (e.g., en)" class="bg-slate-700 rounded-md px-3 py-2 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 hidden" />
                        <input name="url" placeholder="URL" required class="bg-slate-700 rounded-md px-3 py-2 border border-slate-600 focus:outline-none focus:ring-2 focus:ring-cyan-500 sm:col-span-2" />
                        <button type="submit" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-md transition-colors duration-300 sm:col-span-2">
                            Add Resource by URL
                        </button>
                    </form>
                </details>
            </div>

            <div id="player-wrapper" class="w-full aspect-video rounded-lg overflow-hidden shadow-2xl shadow-cyan-500/10 bg-black">
                <!-- Video Player will be inserted here by JS -->
            </div>

            <div class="bg-slate-800 rounded-lg p-4 sm:p-6 mt-8 shadow-lg">
                <h2 class="text-2xl font-bold text-cyan-400 mb-4">Generate Embed Code</h2>
                <p class="text-slate-400 mb-4">Copy and paste this code into your HTML to embed the configured video player. Note: Subtitles uploaded from local files will not be included.</p>
                <div class="relative">
                    <textarea id="embed-code-textarea" readOnly placeholder="Load a video to generate embed code..." class="w-full h-24 bg-slate-900 text-slate-300 font-mono text-sm p-3 rounded-md border border-slate-600 resize-none focus:outline-none focus:ring-2 focus:ring-cyan-500" aria-label="Embed code"></textarea>
                    <button id="copy-embed-btn" class="absolute top-2 right-2 bg-slate-700 hover:bg-slate-600 text-white py-1 px-3 rounded-md text-sm transition-colors" title="Copy to clipboard">
                        Copy
                    </button>
                </div>
            </div>

            <footer class="text-center mt-8 text-slate-500 text-sm">
                <p>Built with Vanilla JS, HTML, and Tailwind CSS.</p>
                <p>Note: Cross-origin (CORS) policies may prevent some video URLs from loading.</p>
            </footer>
        </div>
    </div>
    
    <div id="embed-container" class="w-full h-full bg-black hidden">
        <!-- Player for embed mode will be inserted here -->
    </div>


    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let sources = [];
            let subtitles = [];
            let isEmbedMode = false;
            let controlsTimeout;
            
            // --- DOM ELEMENT REFERENCES ---
            const appContainer = document.getElementById('app-container');
            const embedContainer = document.getElementById('embed-container');
            const videoUrlInput = document.getElementById('video-url-input');
            const loadVideoBtn = document.getElementById('load-video-btn');
            const addResourceForm = document.getElementById('add-resource-form');
            const resourceTypeSelect = document.getElementById('resource-type-select');
            const langInput = addResourceForm.querySelector('input[name="lang"]');
            const embedCodeTextarea = document.getElementById('embed-code-textarea');
            const copyEmbedBtn = document.getElementById('copy-embed-btn');
            const playerWrapper = document.getElementById('player-wrapper');

            // --- PLAYER UI TEMPLATE ---
            const createPlayerHTML = (isEmbed = false) => `
                <div id="player-container" class="relative w-full h-full bg-black group">
                    <video id="video-player" class="w-full h-full" crossOrigin="anonymous"></video>
                    <div id="controls-overlay" class="absolute inset-0 bg-black bg-opacity-30 transition-opacity duration-300 opacity-0 pointer-events-none">
                        <div class="absolute bottom-0 left-0 right-0 p-4 text-white bg-gradient-to-t from-black/70 to-transparent">
                            <input id="progress-bar" type="range" min="0" max="1" step="0.001" value="0" class="w-full h-1.5 rounded-full appearance-none cursor-pointer progress-bar" />
                            <div class="flex items-center justify-between mt-2">
                                <div class="flex items-center gap-4">
                                    <button id="play-pause-btn">
                                        <svg id="play-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5V19L19 12L8 5Z" /></svg>
                                        <svg id="pause-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="hidden"><path d="M6 19H10V5H6V19ZM14 5V19H18V5H14Z" /></svg>
                                    </button>
                                    <div class="flex items-center gap-2">
                                        <button id="mute-btn">
                                            <svg id="volume-high-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9V15H7L12 20V4L7 9H3ZM16.5 12C16.5 10.23 15.54 8.71 14 7.97V16.02C15.54 15.29 16.5 13.77 16.5 12ZM14 3.23V5.29C16.89 6.15 19 8.83 19 12C19 15.17 16.89 17.84 14 18.7V20.77C18.01 19.86 21 16.28 21 12C21 7.72 18.01 4.14 14 3.23Z" /></svg>
                                            <svg id="volume-mute-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="hidden"><path d="M16.5 12C16.5 10.23 15.54 8.71 14 7.97V10.18L16.45 12.63C16.48 12.43 16.5 12.21 16.5 12ZM19 12C19 12.94 18.8 13.82 18.46 14.64L19.97 16.15C20.62 14.91 21 13.5 21 12C21 7.72 18.01 4.14 14 3.23V5.29C16.89 6.15 19 8.83 19 12ZM4.27 3L3 4.27L7.73 9H3V15H7L12 20V13.27L16.25 17.52C15.58 17.84 14.83 18.09 14 18.22V20.77C15.38 20.45 16.63 19.82 17.68 18.96L19.73 21L21 19.73L4.27 3ZM12 4L9.91 6.09L12 8.18V4Z" /></svg>
                                        </button>
                                        <input id="volume-bar" type="range" min="0" max="1" step="0.01" value="1" class="w-20 h-1.5 rounded-full appearance-none cursor-pointer volume-bar" />
                                    </div>
                                    <span id="time-display" class="text-sm font-mono">00:00 / 00:00</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <div class="relative">
                                        <input type="file" id="subtitle-upload-input" accept=".srt,.vtt" class="hidden" />
                                        <button id="subtitles-btn" title="Subtitles">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM4 12H8V14H4V12ZM14 18H4V16H14V18ZM20 18H16V16H20V18ZM20 14H10V12H20V14Z" /></svg>
                                        </button>
                                        <div id="subtitles-menu" class="absolute bottom-full right-0 mb-2 bg-slate-800/90 rounded-md p-2 min-w-[150px] hidden flex-col items-start"></div>
                                    </div>
                                    <div class="relative">
                                        <button id="settings-btn" title="Settings">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19.43 12.98C19.47 12.66 19.5 12.34 19.5 12C19.5 11.66 19.47 11.34 19.43 11.02L21.54 9.37C21.73 9.22 21.78 8.95 21.66 8.73L19.66 5.27C19.54 5.05 19.27 4.96 19.05 5.05L16.56 6.05C16.04 5.66 15.48 5.31 14.87 5.07L14.49 2.42C14.46 2.18 14.25 2 14 2H10C9.75 2 9.54 2.18 9.51 2.42L9.13 5.07C8.52 5.31 7.96 5.66 7.44 6.05L4.95 5.05C4.73 4.96 4.46 5.05 4.34 5.27L2.34 8.73C2.21 8.95 2.27 9.22 2.46 9.37L4.57 11.02C4.53 11.34 4.5 11.66 4.5 12C4.5 12.34 4.53 12.66 4.57 12.98L2.46 14.63C2.27 14.78 2.21 15.05 2.34 15.27L4.34 18.73C4.46 18.95 4.73 19.04 4.95 18.95L7.44 17.94C7.96 18.34 8.52 18.69 9.13 18.93L9.51 21.58C9.54 21.82 9.75 22 10 22H14C14.25 22 14.46 21.82 14.49 21.58L14.87 18.93C15.48 18.69 16.04 18.34 16.56 17.94L19.05 18.95C19.27 19.04 19.54 18.95 19.66 18.73L21.66 15.27C21.78 15.05 21.73 14.78 21.54 14.63L19.43 12.98ZM12 15.5C10.07 15.5 8.5 13.93 8.5 12C8.5 10.07 10.07 8.5 12 8.5C13.93 8.5 15.5 10.07 15.5 12C15.5 13.93 13.93 15.5 12 15.5Z" /></svg>
                                        </button>
                                        <div id="settings-menu" class="absolute bottom-full right-0 mb-2 bg-slate-800/90 rounded-md p-2 min-w-[120px] hidden"></div>
                                    </div>
                                    <button id="fullscreen-btn" title="Fullscreen">
                                        <svg id="fullscreen-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5V19H10V17H7V14ZM5 10H7V5H10V3H5V10ZM17 17H14V19H19V14H17V17ZM14 3V5H17V10H19V5H14Z" /></svg>
                                        <svg id="fullscreen-exit-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="hidden"><path d="M5 16H8V19H10V14H5V16ZM8 8H5V10H10V5H8V8ZM14 19H16V16H19V14H14V19ZM16 8V5H14V10H19V8H16Z" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // --- PLAYER LOGIC ---
            function setupPlayer(container, isEmbedPlayer) {
                container.innerHTML = createPlayerHTML(isEmbedPlayer);

                // Player DOM elements
                const playerContainer = container.querySelector('#player-container');
                const video = container.querySelector('#video-player');
                const controlsOverlay = container.querySelector('#controls-overlay');
                const playPauseBtn = container.querySelector('#play-pause-btn');
                const playIcon = container.querySelector('#play-icon');
                const pauseIcon = container.querySelector('#pause-icon');
                const progressBar = container.querySelector('#progress-bar');
                const timeDisplay = container.querySelector('#time-display');
                const muteBtn = container.querySelector('#mute-btn');
                const volumeHighIcon = container.querySelector('#volume-high-icon');
                const volumeMuteIcon = container.querySelector('#volume-mute-icon');
                const volumeBar = container.querySelector('#volume-bar');
                const fullscreenBtn = container.querySelector('#fullscreen-btn');
                const fullscreenIcon = container.querySelector('#fullscreen-icon');
                const fullscreenExitIcon = container.querySelector('#fullscreen-exit-icon');
                const settingsBtn = container.querySelector('#settings-btn');
                const settingsMenu = container.querySelector('#settings-menu');
                const subtitlesBtn = container.querySelector('#subtitles-btn');
                const subtitlesMenu = container.querySelector('#subtitles-menu');
                const subtitleUploadInput = container.querySelector('#subtitle-upload-input');
                
                let activeSubtitleSrc = '';

                // --- Helper Functions ---
                const formatTime = (timeInSeconds) => {
                    if (isNaN(timeInSeconds)) return '00:00';
                    const minutes = Math.floor(timeInSeconds / 60);
                    const seconds = Math.floor(timeInSeconds % 60);
                    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                };

                const showControls = () => {
                    controlsOverlay.classList.remove('opacity-0', 'pointer-events-none');
                    controlsOverlay.classList.add('opacity-100');
                };

                const hideControls = () => {
                    if (video.paused) return;
                    controlsOverlay.classList.add('opacity-0', 'pointer-events-none');
                    controlsOverlay.classList.remove('opacity-100');
                    settingsMenu.classList.add('hidden');
                    subtitlesMenu.classList.add('hidden');
                };

                const resetControlsTimeout = () => {
                    clearTimeout(controlsTimeout);
                    showControls();
                    controlsTimeout = setTimeout(hideControls, 3000);
                };

                // --- DOM Update Functions ---
                const updatePlayButton = () => {
                    if (video.paused) {
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                    } else {
                        playIcon.classList.add('hidden');
                        pauseIcon.classList.remove('hidden');
                    }
                };

                const updateTimeAndProgress = () => {
                    const progress = video.currentTime / video.duration;
                    progressBar.value = progress || 0;
                    timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
                };

                const updateVolumeControls = () => {
                    const isMuted = video.muted || video.volume === 0;
                    volumeBar.value = isMuted ? 0 : video.volume;
                    volumeHighIcon.classList.toggle('hidden', isMuted);
                    volumeMuteIcon.classList.toggle('hidden', !isMuted);
                };
                
                const updateFullscreenButton = () => {
                    const isFullscreen = !!document.fullscreenElement;
                    fullscreenIcon.classList.toggle('hidden', isFullscreen);
                    fullscreenExitIcon.classList.toggle('hidden', !isFullscreen);
                };

                const renderQualityMenu = () => {
                    settingsMenu.innerHTML = '';
                    if (sources.length <= 1) {
                       settingsBtn.classList.add('hidden');
                       return;
                    }
                    settingsBtn.classList.remove('hidden');
                    
                    const header = document.createElement('p');
                    header.className = 'text-sm text-slate-400 px-2 pb-1';
                    header.textContent = 'Quality';
                    settingsMenu.appendChild(header);

                    sources.forEach(source => {
                        const button = document.createElement('button');
                        button.className = 'w-full text-left px-2 py-1 rounded hover:bg-slate-700';
                        button.textContent = source.label;
                        if (video.src === source.src) {
                            button.classList.add('text-cyan-400', 'font-bold');
                        }
                        button.onclick = () => {
                            const currentTime = video.currentTime;
                            const wasPlaying = !video.paused;
                            video.src = source.src;
                            video.load();
                            video.currentTime = currentTime;
                            if (wasPlaying) video.play();
                            renderQualityMenu(); // Re-render to update active state
                            settingsMenu.classList.add('hidden');
                        };
                        settingsMenu.appendChild(button);
                    });
                };
                
                const renderSubtitlesMenu = () => {
                    subtitlesMenu.innerHTML = '';
                    
                    // Add subtitle tracks
                    subtitles.forEach(sub => {
                       const button = document.createElement('button');
                       button.className = `w-full text-left px-2 py-1 rounded hover:bg-slate-700`;
                       button.textContent = sub.label;
                       if (activeSubtitleSrc === sub.src) {
                            button.classList.add('text-cyan-400', 'font-bold');
                       }
                       button.onclick = () => handleSubtitleChange(sub.src);
                       subtitlesMenu.appendChild(button);
                    });
                    
                    // Add "Off" button
                    const offButton = document.createElement('button');
                    offButton.className = `w-full text-left px-2 py-1 rounded hover:bg-slate-700 ${activeSubtitleSrc === '' ? 'text-cyan-400 font-bold' : ''}`;
                    offButton.textContent = 'Off';
                    offButton.onclick = () => handleSubtitleChange('');
                    subtitlesMenu.appendChild(offButton);
                    
                    // Add "Add Subtitle..." button if not in embed mode
                    if (!isEmbedPlayer) {
                        const hr = document.createElement('hr');
                        hr.className = 'w-full border-slate-600 my-1';
                        subtitlesMenu.appendChild(hr);
                        
                        const addButton = document.createElement('button');
                        addButton.className = 'w-full text-left px-2 py-1 rounded hover:bg-slate-700';
                        addButton.textContent = 'Add Subtitle...';
                        addButton.onclick = () => subtitleUploadInput.click();
                        subtitlesMenu.appendChild(addButton);
                    }
                };

                const updateVideoTracks = () => {
                    // Clear existing tracks
                    const oldTracks = video.querySelectorAll('track');
                    oldTracks.forEach(t => t.remove());

                    subtitles.forEach(sub => {
                        const track = document.createElement('track');
                        track.kind = 'subtitles';
                        track.src = sub.src;
                        track.srclang = sub.lang;
                        track.label = sub.label;
                        video.appendChild(track);
                    });
                    
                    // After adding tracks, call subtitle change to set mode
                    handleSubtitleChange(activeSubtitleSrc, true);
                };

                // --- Event Handlers ---
                const togglePlayPause = () => {
                    if (video.paused) {
                        video.play();
                    } else {
                        video.pause();
                    }
                };

                const toggleMute = () => {
                    video.muted = !video.muted;
                    if (!video.muted && video.volume === 0) {
                        video.volume = 0.5;
                    }
                };
                
                const toggleFullScreen = () => {
                    if (!document.fullscreenElement) {
                        playerContainer.requestFullscreen().catch(err => {
                            alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                        });
                    } else {
                        document.exitFullscreen();
                    }
                };
                
                const handleSubtitleChange = (src, forceUpdate = false) => {
                    if (activeSubtitleSrc === src && !forceUpdate) return;
                    
                    activeSubtitleSrc = src;
                    for (let i = 0; i < video.textTracks.length; i++) {
                        const track = video.textTracks[i];
                        // Match based on our internal src URL
                        const correspondingSubtitle = subtitles.find(s => s.src === track.src);
                        track.mode = (correspondingSubtitle && correspondingSubtitle.src === src) ? 'showing' : 'hidden';
                    }
                    subtitlesMenu.classList.add('hidden');
                    renderSubtitlesMenu();
                };
                
                // --- Event Listeners ---
                playPauseBtn.onclick = togglePlayPause;
                video.onclick = togglePlayPause;
                video.onplay = video.onpause = updatePlayButton;
                video.ontimeupdate = updateTimeAndProgress;
                video.onloadedmetadata = updateTimeAndProgress;
                video.onvolumechange = updateVolumeControls;
                
                progressBar.oninput = (e) => video.currentTime = e.target.value * video.duration;
                volumeBar.oninput = (e) => {
                    video.volume = e.target.value;
                    video.muted = e.target.value == 0;
                };

                muteBtn.onclick = toggleMute;
                fullscreenBtn.onclick = toggleFullScreen;
                document.onfullscreenchange = updateFullscreenButton;

                playerContainer.onmousemove = resetControlsTimeout;
                playerContainer.onmouseleave = () => {
                    clearTimeout(controlsTimeout);
                    hideControls();
                };
                playerContainer.onmouseenter = resetControlsTimeout;
                
                settingsBtn.onclick = () => {
                    settingsMenu.classList.toggle('hidden');
                    subtitlesMenu.classList.add('hidden');
                };
                
                subtitlesBtn.onclick = () => {
                    subtitlesMenu.classList.toggle('hidden');
                    settingsMenu.classList.add('hidden');
                };

                subtitleUploadInput.onchange = (e) => {
                    const file = e.target.files?.[0];
                    if (file && (file.name.endsWith('.srt') || file.name.endsWith('.vtt'))) {
                        const newSubtitle = {
                            src: URL.createObjectURL(file),
                            label: file.name.slice(0, 20),
                            lang: 'en', // Default lang
                        };
                        subtitles.push(newSubtitle);
                        updateVideoTracks();
                        renderSubtitlesMenu();
                        if (!isEmbedPlayer) generateEmbedCode(); // Update embed code if applicable
                    } else {
                        alert('Please upload a valid .srt or .vtt file.');
                    }
                };

                // --- Initial Player Setup ---
                if (sources.length > 0) {
                    video.src = sources[0].src;
                }
                updateVideoTracks();
                renderQualityMenu();
                renderSubtitlesMenu();
                updateVolumeControls();
            }
            
            // --- APP LOGIC ---
            
            const generateEmbedCode = () => {
                const embeddableSubtitles = subtitles.filter(sub => !sub.src.startsWith('blob:'));
                if (sources.length === 0 || !sources[0].src) {
                    embedCodeTextarea.value = '';
                    return;
                }

                const baseUrl = window.location.origin + window.location.pathname;
                const params = new URLSearchParams();
                params.set('embed', 'true');
                params.set('sources', JSON.stringify(sources));
                if (embeddableSubtitles.length > 0) {
                    params.set('subtitles', JSON.stringify(embeddableSubtitles));
                }

                const embedUrl = `${baseUrl}?${params.toString()}`;
                embedCodeTextarea.value = `<iframe src="${embedUrl}" width="640" height="360" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
            };

            const loadPrimaryVideo = () => {
                const url = videoUrlInput.value.trim();
                if (url === '' || !url.endsWith('.mp4')) {
                    alert('Please enter a valid MP4 URL.');
                    return;
                }
                sources = [{ src: url, label: 'Default' }];
                subtitles = [];
                setupPlayer(playerWrapper, false);
                generateEmbedCode();
            };

            // --- App Event Listeners ---
            if (!isEmbedMode) {
                loadVideoBtn.onclick = loadPrimaryVideo;
                
                resourceTypeSelect.onchange = (e) => {
                    langInput.classList.toggle('hidden', e.target.value !== 'subtitle');
                    langInput.required = e.target.value === 'subtitle';
                };

                addResourceForm.onsubmit = (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    const type = formData.get('type');
                    const label = formData.get('label');
                    const url = formData.get('url');

                    if (type === 'resolution') {
                        sources.push({ label, src: url });
                    } else {
                        const lang = formData.get('lang');
                        if (!lang) {
                            alert('Please provide a language code (e.g., "en").');
                            return;
                        }
                        subtitles.push({ label, src: url, lang });
                    }
                    
                    setupPlayer(playerWrapper, false); // Re-setup player to reflect changes
                    generateEmbedCode();
                    e.target.reset();
                    langInput.classList.add('hidden');
                };
                
                copyEmbedBtn.onclick = () => {
                    if (!embedCodeTextarea.value) {
                        alert("Load a video first to generate an embed code.");
                        return;
                    }
                    navigator.clipboard.writeText(embedCodeTextarea.value).then(() => {
                        alert('Embed code copied to clipboard!');
                    }, (err) => {
                        alert('Failed to copy embed code.');
                    });
                };
            }
            
            // --- INITIALIZATION ---
            function init() {
                const params = new URLSearchParams(window.location.search);
                isEmbedMode = params.get('embed') === 'true';

                if (isEmbedMode) {
                    appContainer.classList.add('hidden');
                    embedContainer.classList.remove('hidden');
                    document.body.classList.remove('p-4', 'sm:p-8');
                    try {
                        const sourcesParam = params.get('sources');
                        if (sourcesParam) sources = JSON.parse(sourcesParam);
                        const subtitlesParam = params.get('subtitles');
                        if (subtitlesParam) subtitles = JSON.parse(subtitlesParam);
                    } catch (e) {
                        console.error("Failed to parse URL params:", e);
                        sources = [{ src: '', label: 'Error' }];
                    }
                    setupPlayer(embedContainer, true);
                } else {
                    sources = [
                        { src: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4', label: '720p' },
                        { src: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4', label: '480p' }
                    ];
                    subtitles = [];
                    videoUrlInput.value = sources[0].src;
                    setupPlayer(playerWrapper, false);
                    generateEmbedCode();
                }
            }

            init();
        });
    </script>
</body>
</html>
